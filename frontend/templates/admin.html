<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BVC FOOD BITE | Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{
  box-sizing:border-box;
  font-family:Arial, sans-serif;
}
body{
  margin:0;
  background:#f3f4f6;
}

/* HEADER */
header{
  background:#1e293b;
  color:#fff;
  padding:16px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h2{
  margin:0;
}
.logout{
  background:#ff7043;
  border:none;
  padding:8px 18px;
  border-radius:20px;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

/* CONTAINER */
.container{
  padding:20px;
}

/* ORDER CARD */
.order-card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
}
.order-card h3{
  margin:0 0 8px;
  color:#ff7043;
}
.order-card ul{
  padding-left:20px;
  margin:8px 0;
}
.order-card li{
  margin-bottom:4px;
}

.badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:14px;
  font-size:12px;
  font-weight:bold;
  margin-bottom:6px;
}
.pre{
  background:#ffe0b2;
  color:#e65100;
}
.normal{
  background:#c8e6c9;
  color:#1b5e20;
}

.empty{
  text-align:center;
  margin-top:60px;
  color:#777;
  font-size:18px;
}

/* TABS */
.tabs{
  display:flex;gap:10px;padding:12px 20px;background:#fff;border-bottom:2px solid #e5e7eb;
}
.tabs button{
  border:none;padding:10px 18px;background:transparent;
  font-size:15px;font-weight:bold;cursor:pointer;color:#666;
  border-bottom:3px solid transparent;transition:all 0.2s;
}
.tabs button.active{
  color:#ff7043;border-bottom-color:#ff7043;
}

.tab-content{display:none;}
.tab-content.active{display:block;}

/* ADMIN ACTION BUTTONS */
.order-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.order-actions button{
  border:1px solid transparent;padding:8px 12px;border-radius:18px;cursor:pointer;font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px
}
.order-actions button:hover{transform:translateY(-1px)}
.btn-accept{background:#e6f4ea;color:#1b5e20;border-color:rgba(27,94,32,0.08)}
.btn-decline{background:#fdecea;color:#b42b2b;border-color:rgba(180,43,43,0.08)}
.btn-preparing{background:#fff4e6;color:#b35b00;border-color:rgba(179,91,0,0.06)}
.btn-ready{background:#e8f6ef;color:#2e7d32;border-color:rgba(46,125,50,0.08)}
.btn-delivered{background:#e7f0ff;color:#1565c0;border-color:rgba(21,101,192,0.08)}
.btn-delete{background:transparent;color:#b42b2b;border:1px solid #f5c6c6}


/* RATINGS */
.rating-card{
  background:#fff;border-radius:10px;padding:14px;
  margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.rating-card h4{margin:0 0 8px;font-size:14px;color:#ff7043;}
.rating-item{font-size:13px;margin:4px 0;color:#555;}
.star-rating{color:#ffc107;font-weight:bold;}

</style>
</head>

<body>

<header>
  <h2>üõ†Ô∏è Admin Dashboard</h2>
  <div style="display:flex;gap:8px;align-items:center">
    <a href="/feedback.html" style="background:#ff7043;color:#fff;padding:8px 14px;border-radius:20px;text-decoration:none;font-weight:bold">‚≠ê Feedback</a>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <h3>üì¶ Orders & Ratings</h3>
  
  <div class="tabs">
    <button class="active" onclick="switchTab('orders',this)">üì¶ Orders</button>
    <button onclick="switchTab('ratings',this)">‚≠ê Ratings</button>
  </div>
  
  <div id="orders" class="tab-content active"></div>
  <div id="ratings" class="tab-content"></div>
</div>

<script>
// Sync server-provided name/mobile into localStorage when available
;(function(){
  const serverName = "{{ server_name|e }}";
  const serverMobile = "{{ server_mobile|e }}";
  const serverRole = "{{ server_role|e }}";
  try{ 
    if(serverName) localStorage.setItem('loggedUser', serverName);
    if(serverMobile) localStorage.setItem('loggedUserMobile', serverMobile);
    if(serverRole) localStorage.setItem('role', serverRole);
  }catch(e){}
})();

function logout(){
  try{
    localStorage.removeItem('loggedUser');
    localStorage.removeItem('loggedUserMobile');
    localStorage.removeItem('role');
  }catch(e){}

  // Navigate to server-side logout (server expects GET and clears session)
  try{
    location.href = '/logout';
  }catch(e){
    location.href = '/';
  }
}

// Prefer server-provided role (avoids race where localStorage isn't populated yet)
const _serverRole = "{{ server_role|e }}";
if((_serverRole && _serverRole !== 'admin') || (!_serverRole && localStorage.getItem("role") !== "admin")){
  alert("Access denied");
  // clear server session (if any) before redirecting to login
  location.href = "/logout";
}

const ordersDiv = document.getElementById("orders");

async function fetchOrders(){
  try{
    const res = await fetch('/api/orders');
    if(!res.ok) throw new Error('API error');
    const orders = await res.json();
    renderOrders(orders);
  }catch(e){
    // fallback to localStorage
    const orders = JSON.parse(localStorage.getItem("orders") || "[]");
    renderOrders(orders);
  }
}

function renderOrders(orders){
  ordersDiv.innerHTML = "";
  if(orders.length === 0){
    ordersDiv.innerHTML = `<div class="empty">No orders received yet</div>`;
    return;
  }

  orders.slice().reverse().forEach((order) => {
    let itemsHTML = "";
    for(let item in order.items){
      itemsHTML += `<li>${item} √ó ${order.items[item]}</li>`;
    }

    ordersDiv.innerHTML += `
      <div class="order-card">
        <h3>üßæ ${order.id}</h3>

        <p><b>üë§ Name:</b> ${order.name || '‚Äî'}</p>
        <p><b>üì± Mobile:</b> ${order.mobile ? order.mobile : 'Not provided'}</p>
        <p><b>üí≥ Payment:</b> ${order.payment}</p>

        <span class="badge ${order.preOrder ? 'pre' : 'normal'}">
          ${order.preOrder ? 'Pre-Order' : 'Normal Order'}
        </span>

        <p><b>Status:</b> 
          <b style="color:${
            order.status === "ACCEPTED" ? "green" :
            order.status === "DECLINED" ? "red" : "orange"
          }">
            ${order.status || "PENDING"}
          </b>
        </p>

        ${
          order.preOrder && order.delivery
          ? `<p><b>üéÇ Delivery:</b> ${order.delivery.date} ${order.delivery.time}</p>`
          : ``
        }

        <p><b>üçΩÔ∏è Items:</b></p>
        <ul>${itemsHTML}</ul>

        ${
          // always allow admin actions for orders (status toggles)
          `
            <div class="order-actions">
              <button class="btn-accept" onclick="updateStatus('${order.id}', 'ACCEPTED')">‚úÖ Accept</button>
              <button class="btn-decline" onclick="updateStatus('${order.id}', 'DECLINED')">‚ùå Decline</button>
              <button class="btn-preparing" onclick="updateStatus('${order.id}', 'PREPARING')">üë©‚Äçüç≥ Preparing</button>
              <button class="btn-ready" onclick="updateStatus('${order.id}', 'READY')">‚úÖ Ready</button>
              <button class="btn-delivered" onclick="updateStatus('${order.id}', 'DELIVERED')">üì¶ Delivered</button>
              <button class="btn-delete" onclick="deleteOrder('${order.id}')">üóëÔ∏è Delete</button>
            </div>
          `
        }
      </div>
    `;
  });
}

async function updateStatus(orderId, status){
  try{
    const res = await fetch(`/api/orders/${orderId}/status`, {
      method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({status})
    });
    if(!res.ok) throw new Error('update failed');
    await fetchOrders();
  }catch(e){
    // fallback to localStorage update
    let orders = JSON.parse(localStorage.getItem('orders')||'[]');
    const idx = orders.findIndex(o=>o.id===orderId);
    if(idx>=0){ orders[idx].status = status; localStorage.setItem('orders', JSON.stringify(orders)); fetchOrders(); }
  }
}

async function deleteOrder(orderId){
  if(!confirm('Delete order ' + orderId + ' ?')) return;
  try{
    const res = await fetch(`/api/orders/${orderId}`, { method: 'DELETE' });
    if(!res.ok) throw new Error('delete failed');
    await fetchOrders();
  }catch(e){
    // fallback to localStorage
    let orders = JSON.parse(localStorage.getItem('orders')||'[]');
    orders = orders.filter(o=>o.id!==orderId);
    localStorage.setItem('orders', JSON.stringify(orders));
    fetchOrders();
  }
}

/* RATINGS */
const ratingsDiv = document.getElementById("ratings");

async function fetchRatings(){
  try{
    const res = await fetch('/api/ratings');
    if(!res.ok) throw new Error('API error');
    const ratings = await res.json();
    renderRatings(ratings);
  }catch(e){
    ratingsDiv.innerHTML = `<div class="empty">Unable to load ratings</div>`;
  }
}

function renderRatings(ratings){
  if(!ratings.length){
    ratingsDiv.innerHTML = `<div class="empty">No ratings yet</div>`;
    return;
  }
  
  // Group by item
  const byItem = {};
  ratings.forEach(r => {
    if(!byItem[r.item_name]) byItem[r.item_name] = [];
    byItem[r.item_name].push(r);
  });
  
  ratingsDiv.innerHTML = "";
  for(let itemName in byItem){
    const itemRatings = byItem[itemName];
    const avgRating = (itemRatings.reduce((sum, r) => sum + r.rating, 0) / itemRatings.length).toFixed(1);
    
    ratingsDiv.innerHTML += `
      <div class="rating-card">
        <h4>üçΩÔ∏è ${itemName}</h4>
        <div class="rating-item"><span class="star-rating">‚≠ê ${avgRating}/5</span> (${itemRatings.length} reviews)</div>
        ${itemRatings.map(r => `
          <div class="rating-item">
            <b>${r.user_name}</b> (${r.user_mobile}): 
            <span class="star-rating">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</span>
            ${r.review ? `<br><em>"${r.review}"</em>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }
}

function switchTab(tab, btn){
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  btn.classList.add('active');
  
  if(tab === 'ratings') fetchRatings();
}

fetchOrders();
setInterval(fetchOrders, 5000); // Refresh orders every 5s
</script>

<script>
try{ if(location.protocol === 'file:') location.href = 'http://127.0.0.1:5000/'; }catch(e){}
</script>
